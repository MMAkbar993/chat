@extends('installer::app')
@section('content')
    <div class="card">
        <div class="card-header d-flex justify-content-between">
            <p>Configure Your Website</p>
            <div>
                <a class="btn btn-outline-primary" href="{{route('setup.account')}}">&laquo; Back</a>
                <a class="btn btn-outline-primary @if (!session()->has('step-5-complete')) disabled @endif" href="{{route('setup.complete')}}">Next &raquo;</a>
            </div>
        </div>
        <div class="card-body">
            <form id="config_form" autocomplete="off">
                <div class="mb-3">
                    <label>App Name <span class="text-danger">*</span></label>
                    <input type="text" id="config_app_name" name="config_app_name" class="form-control"
                        value="{{ old('config_app_name',$app_name ?? null) }}" placeholder="Enter Your App Name">
                </div>
                <button type="submit" id="submit_btn" class="btn btn-primary">Save Config</button>
            </form>
        </div>
        <div class="card-footer text-center">
            <p>For script support, contact us at <a href="https://dreamstechnologies.com/page/support"
                target="_blank" rel="noopener noreferrer">@dreamstechnologies</a>. We're here to help. Thank you!</p>
        </div>
    </div>
@endsection
@push('scripts')
    <script type="module">
         import {
        initializeApp
    } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
    import {
        getAuth,
        onAuthStateChanged,
        sendPasswordResetEmail,
        setPersistence,
        browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
    import {
        getDatabase,
        ref,
        push,
        onChildAdded,
        get,
        onValue,
        update,
        remove,
        set,
        onDisconnect,
        child,
        query,
        orderByChild,
        equalTo,
        onChildChanged
    } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";
    import {
        getStorage,
        ref as storageRef,
        uploadBytes,
        getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-storage.js";
    import {
        getFirestore,
        collection,
        getDocs,
        where
    } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"; // Use this URL for Firestore
    const firebaseConfig = {

        apiKey: "{{ env('FIREBASE_API_KEY') }}",
        authDomain: "{{ env('FIREBASE_AUTH_DOMAIN') }}",
        databaseURL: "{{ env('FIREBASE_DATABASE_URL') }}",
        projectId: "{{ env('FIREBASE_PROJECT_ID') }}",
        storageBucket: "{{ env('FIREBASE_STORAGE_BUCKET') }}",
        messagingSenderId: "{{ env('FIREBASE_MEASUREMENT_ID')}}",
        appId: "{{ env('FIREBASE_APP_ID')}}",

    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const storage = getStorage();
    const firestore = getFirestore(app);
        $(document).ready(function() {
            $(document).on('submit', '#config_form', async function(e) {
                e.preventDefault();
                let config_app_name = $('#config_app_name').val();
                let submit_btn = $('#submit_btn');

                if ($.trim(config_app_name) === '') {
                    toastr.warning("App Name is required");
                } else {
                    submit_btn.html(
                        'Saving... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>'
                    ).prop('disabled', true);
                    try {

                        const callRef = ref(database, `data/app_settings/`);
                    const uniqueCallId = push(callRef).key;

                    const newUserContactsRef = ref(database, 'data/app_settings/');
                    set(newUserContactsRef, {
                        site_name: config_app_name,
                    });



                        const res = await makeAjaxRequest({
                                config_app_name: config_app_name
                            },
                            "{{ route('setup.configuration.submit') }}");
                        if (res.success) {
                            toastr.success(res.message);
                            submit_btn.addClass('btn-success').html('Redirecting...');
                            window.location.href = "{{ route('setup.complete') }}";
                        } else {
                            submit_btn.html('Save Config').prop('disabled', false);
                            toastr.error(res.message);
                        }
                    } catch (error) {
                        submit_btn.html('Save Config').prop('disabled', false);
                        $.each(error.errors, function(index, value) {
                            toastr.error(value);
                        });
                    }
                }
            });
        });
    </script>
@endpush